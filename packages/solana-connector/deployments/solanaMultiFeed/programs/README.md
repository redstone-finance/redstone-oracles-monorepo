# Solana Contracts — general assumptions

<!-- TOC -->

- [Solana Contracts — general assumptions](#solana-contracts--general-assumptions)
  - [RedStone Solana Price Adapter](#redstone-solana-price-adapter)
    - [Already deployed addresses](#already-deployed-addresses)
  - [Usage](#usage)
    - [Feed accounts](#feed-accounts)

## RedStone Solana Price Adapter

- The [PriceAdapter](./redstone-solana-price-adapter/README.md) contract is updated from one or more off-chain processes.
- The data are written to a [`PriceData`](./redstone-solana-price-adapter/src/state.rs) account created per Feed id.
  - The `value` field is encoded as a 256-bit big-endian value (for Rust, `u256` big-endian encoded)
  - The number of decimals is for now constant and equal to `8`
- The contract can be read by one of `view` functions.
- The parameters`/logic update requires changing the code.
  - Still, **the account [`PriceData`](./redstone-solana-price-adapter/src/state.rs) ID remains unchanged**
    and is readable forever.
- The IDL files are available in the [src/\_autogenerated](../../../src/_autogenerated) directory.
  - The address field there is empty, use the deployed one.

### Already deployed addresses

- Mainnet: [`REDSTBDUecGjwXd6YGPzHSvEUBHQqVRfCcjUVgPiHsr`](https://solscan.io/account/REDSTBDUecGjwXd6YGPzHSvEUBHQqVRfCcjUVgPiHsr)
- Testnet: [`rds8J7VKqLQgzDr7vS59dkQga3B1BotgFy8F7LSLC74`](https://solscan.io/account/rds8J7VKqLQgzDr7vS59dkQga3B1BotgFy8F7LSLC74?cluster=testnet)
- Devnet: [`REDuYsnEucMweattdv4xQCYdU1i8Q2W92kdayrpY9rA`](https://solscan.io/account/REDuYsnEucMweattdv4xQCYdU1i8Q2W92kdayrpY9rA?cluster=devnet)

> ⚠️ The Testnet and Devnet contracts are deployed by using RedStone dev infrastructure and may contain some gaps in data when it's being upgraded

## Usage

Example of reading price data of a feed. To get account address of the `price_info` you can use following snipet:

```ts
const PROGRAM_ID = new PublicKey("REDSTBDUecGjwXd6YGPzHSvEUBHQqVRfCcjUVgPiHsr")
const FEED_ID = "ETH"

const makeFeedIdBytes = (feedId: string) => {
    return Buffer.from(feedId.padEnd(32, "\0"));
};

const makePriceSeed = () => {
    return Buffer.from("price".padEnd(32, "\0"));
};

const seeds = [
    makePriceSeed(),
    makeFeedIdBytes(FEED_ID)
]

const address = PublicKey.findProgramAddressSync(
    seeds
    PROGRAM_ID
)[0];
```

Once you have it, you can read from it like that:

```rust
use anchor_lang::prelude::*;
use anchor_lang::Discriminator;

#[account]
pub struct PriceData {
    pub feed_id: [u8; 32],
    pub value: [u8; 32],
    pub timestamp: u64,
    pub write_timestamp: Option<u64>,
    pub update_slot: u64m
    pub decimals: u8,
    _reserved: [u8; 64]
}


fn redstone_value_to_price(raw_be_value: [u8; 32]) -> Result<u64> {
    if !raw_be_value.iter().take(24).all(|&v| v == 0) {
        warn!("Price overflow u64");
        return Err(...); // OVERFLOW
    }

    u64::from_be_bytes(raw_be_value[24..].try_into().unwrap())
}

#[program]
pub mod test_usage {
    use super::*;
    pub fn initialize(ctx: Context<Initialize>) -> Result<()> {
        let price_data: PriceData = account_deserialize(&ctx.accounts.price_info);

        let value = redstone_value_to_price(price_data.value)
        msg!("FeedId: {:?}, {:?}", price_data.feed_id, value);
        Ok(())
    }
}
pub fn account_deserialize<T: AccountDeserialize + Discriminator>(
    account: &AccountInfo<'_>,
) -> T {
    let data = account.clone().data.borrow().to_owned();
    let discriminator = data.get(..8).unwrap();
    if discriminator != T::discriminator() {
        panic!(
            "Expected discriminator for account {:?} ({:?}) is different from received {:?}",
            account.key(),
            T::discriminator(),
            discriminator
        );
    }
    let mut data: &[u8] = &data;
    T::try_deserialize(&mut data).unwrap()
}

#[derive(Accounts)]
pub struct Initialize<'info> {
    /// CHECK: ...
    #[account()]
    pub price_info: AccountInfo<'info>,
}
```

### Feed accounts

|                            | mainnet-beta                                 | testnet                                      | devnet                                       |
| -------------------------- | -------------------------------------------- |----------------------------------------------|----------------------------------------------|
| ETH                        | HPmPoq3eUTPePsDB5U4G6msu5RpeZHhMemc5VnqxQ9Lx | BsFkAfSgub54ZMHxZpCXqB3zpWXF8NwAswbuNX1Jq55g | 6bgjyNJ18vWGjw2qjjseSBaDK4QbJF8sjsHAhwy8EuBW |
| BTC                        | 74o5fhuMC33HgfUqvv2TdpYiKvEWfcRTS1E8zxK6ESjN | FbTaAY9o6MU3xZKXT65xE3wATNrxU7nTnZZPmg4gS9Ad | AhQGbBqhbcqJhV7WJ5GktjtjM7dHBPYv2uFhL7Cy7gzQ |
| BUIDL_SOLANA_FUNDAMENTAL   | ESxdEASDcYRN4ybnYNCJJuPHcF2SGJN1MypQq1yfY9Kz | x                                            | x                                            |
| BUIDL_SOLANA_DAILY_ACCRUAL | CPKJ57Kvxf8Xrz1o3hqBK52SqqEUAPp1NVdCK94bDGSX | x                                            | x                                            |
| ACRED_SOLANA_FUNDAMENTAL   | 6sK8czVw8Xy6T8YbH6VC8p5ovNZD2mXf5vUTv8sgnUJf | x                                            | x                                            |
| sUSDS_FUNDAMENTAL          | x                                            | x                                            | BsakcTH9iP8vqvf9SvA6jQQfjn48qhCrUdP1EX4h1smY |
| VBILL_SOLANA_FUNDAMENTAL   | H9ckR9pZtPZCjRYz9RXBPhc2X6m4e3ndpxgVe7HgYVMd | x                                            | x                                            |
| LBTC_FUNDAMENTAL           | EjN4MxDvAbBEofxFwpvCsz2u8wZ96kHMsLmk2N5Bvomt | x                                            | x                                            |
| VBILL_SOLANA_DAILY_ACCRUAL | 8aMjLzsmjSEGmgybHWELTEinTw4kn3okfos5zHrt2TJG | x                                            | x                                            |
