include ./ops.mk

VERSION=0.4.4
SVER=v7
LEDGER_HOST=localhost
LEDGER_PORT=6865
DAML=daml # dpm

TEST_DAR=.daml/dist/redstone-test-$(SVER)-$(VERSION).dar

.PHONY: get_party_suffix

build-%:
	cd $* && $(DAML) build

clean-%:
	cd $* && $(DAML) clean

build_redstone_adapter: build-sdk build-interface build-adapter

build_redstone_core: build-sdk build-interface build-core

build_test:
	$(DAML) build --all

run-%: build_test
	cd test && $(DAML) script --ide-ledger \
		--dar $(TEST_DAR) \
		--script-name $*:main \
		--input-file input.json

clean:
	$(DAML) clean --all
	rm -f $(ADAPTER_ID_TXT) $(PRICE_FEED_ID_TXT) $(CORE_ID_TXT) refresh_token.txt token.txt test/input.json test/sample_data/payload.hex

lint: lint-sdk lint-core lint-adapter lint-price_feed lint-interface lint-test lint-featured lint-factory
	./lint-whitespaces.sh

build: build_test

lint-%:
	cd $* && $(DAML) damlc lint

run_main: run-Main

run_test: build_test lint-test run-Test run-Core run-Featured run-Factory

test-%: build_redstone_adapter build_redstone_core build_test
	cd test && $(DAML) script --ide-ledger \
		--dar $(TEST_DAR) \
		--script-name $*:main

test: test-DerTests test-U256Tests test-U256ConversionTests

integration_tests: prepare_data run_main run_test

run_ledger: ledger-Run

ledger-%: build_test
	cd test && $(DAML) script --script-name $*:main \
	--ledger-host $(LEDGER_HOST) \
	--ledger-port $(LEDGER_PORT) \
	--input-file input.json \
	--dar $(TEST_DAR)

start:
	cd test && $(DAML) start

start_daemon:
	make start & \
	sleep 20

ledger_deploy: build ledger-Deploy

ledger_tests: allocate_parties get_party_suffix ledger_deploy run_ledger

archive: ledger-Archive

allocate_parties:
	@$(DAML) ledger allocate-parties RedStoneOracleOwner RedStoneOracleUpdater RedStoneOracleViewer Client Beneficiary \
	--host $(LEDGER_HOST) \
	--port $(LEDGER_PORT)

list_parties:
	@$(DAML) ledger list-parties \
	--host $(LEDGER_HOST) \
	--port $(LEDGER_PORT)

get_party_suffix:
	@HASH=$$(make list_parties | grep -o '[a-f0-9]\{68\}' | head -1); \
	if [[ "$$(uname)" == "Darwin" ]]; then \
		sed -i '' "s/::[a-f0-9]\{68\}/::$$HASH/g" test/input.json; \
		sed -i '' "s/::[a-f0-9]\{68\}/::$$HASH/g" test/input.json.input; \
	else \
		sed -i "s/::[a-f0-9]\{68\}/::$$HASH/g" test/input.json; \
		sed -i "s/::[a-f0-9]\{68\}/::$$HASH/g" test/input.json.input; \
	fi

codegen:
	curl http://localhost:7575/docs/openapi -o ../src/_autogenerated/openapi.yaml
	npx openapi-typescript-codegen --input ./src/_autogenerated/openapi.yaml --output ./src/_autogenerated --client axios
