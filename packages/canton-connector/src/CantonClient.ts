import { RedstoneCommon } from "@redstone-finance/utils";
import { DefaultService, OpenAPI } from "./_autogenerated";
import type { ApiRequestOptions } from "./_autogenerated/core/ApiRequestOptions";
import { makeInterfaceFilterByParty, unwrapResponse } from "./utils";

export class CantonClient {
  constructor(
    readonly partyId: string,
    baseUrl: string,
    tokenProvider: undefined | ((options: ApiRequestOptions) => Promise<string>),
    apiConfig = OpenAPI
  ) {
    apiConfig.BASE = baseUrl;
    apiConfig.TOKEN = tokenProvider;
  }
  // eslint-disable-next-line @typescript-eslint/class-methods-use-this -- Don't want for now
  async getCurrentOffset() {
    return (await unwrapResponse(DefaultService.getV2StateLedgerEnd())).offset;
  }

  async getActiveContractId<T>(interfaceId: string, filter?: (createArgument: T) => boolean) {
    const filtersByParty = makeInterfaceFilterByParty(interfaceId, this.partyId);

    const contracts = (
      await unwrapResponse(
        DefaultService.postV2StateActiveContracts({
          filter: {
            filtersByParty,
          },
          activeAtOffset: await this.getCurrentOffset(),
          verbose: false,
        })
      )
    ).filter(
      (contract) =>
        "JsActiveContract" in contract.contractEntry &&
        (!filter ||
          filter(contract.contractEntry.JsActiveContract.createdEvent.createArgument as T))
    );

    if (contracts.length === 1 && "JsActiveContract" in contracts[0].contractEntry) {
      return contracts[0].contractEntry.JsActiveContract.createdEvent.contractId;
    }

    throw new Error(RedstoneCommon.stringify(contracts));
  }

  async exerciseChoice<T extends object, U = object>(
    command: { templateId: string; contractId: string; choice: string; choiceArgument: T },
    addCurrentTime = false
  ) {
    const timestamp = new Date();
    const choiceArgument = addCurrentTime
      ? { ...command.choiceArgument, currentTime: timestamp.toISOString() }
      : command.choiceArgument;

    const result = await unwrapResponse(
      // eslint-disable-next-line @typescript-eslint/no-deprecated -- needed and available for 3.4.9 for now
      DefaultService.postV2CommandsSubmitAndWaitForTransactionTree({
        commands: [
          {
            ExerciseCommand: { ...command, choiceArgument },
          },
        ],
        commandId: `${command.contractId}-${command.choice}-${timestamp.getMilliseconds()}`,
        actAs: [this.partyId],
      })
    );

    const event = result.transactionTree.eventsById["0"];
    if ("ExercisedTreeEvent" in event) {
      return event.ExercisedTreeEvent.value.exerciseResult as U;
    }

    throw new Error(RedstoneCommon.stringify(event));
  }
}
